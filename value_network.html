<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Value network &#8212; SynTool 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=039e1c02" />
    <script src="_static/documentation_options.js?v=f2a433a1"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Retrosynthesis planning" href="retrosynthesis_planning.html" />
    <link rel="prev" title="Policy network" href="policy_network.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="value-network">
<span id="id1"></span><h1>Value network<a class="headerlink" href="#value-network" title="Link to this heading">¶</a></h1>
<p>This page explains how to train a value network in SynTool.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p><strong>Node evaluation</strong>. During the evaluation step, the value function (or evaluation function) is used to estimate the
retrosynthetic feasibility of newly created nodes. In SynTool, there are three types of evaluation functions implemented:</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>random function</cite> (assigns a random value between 0 and 1 to the new node). Mostly used as a baseline.</p></li>
<li><p><cite>rollout function</cite> (default evaluation type in MCTS). In the current implementation it does a series of node expansions until it reaches some stope criterion (maximum simulation depth, discovered retrosynthetic route, etc.). Based on the simulation results it assigns the value between (-1 and 1) to the new node.</p></li>
<li><p><cite>value network</cite> (instantly predicts the value between 0 and 1). The value neural network is trained on the data from planning simulations (performed with the previous version of the value network) including examples with precursors leading to the solutions and those which are part of the unsuccessful routes.</p></li>
</ul>
</div></blockquote>
<p><strong>Value network tuning</strong>. The training set for the value neural network is generated from the simulations of planning sessions.
In the first iteration, the value network is initialized with random weights and is used for the initial retrosynthesis
planning session for N target molecules. Then, precursors that were part of a successful retrosynthesis path leading
to building block molecules are labeled with a positive label, and precursors that did not lead to building blocks are
labeled with a negative label. This generated training data is used to train the value network to better recognize precursors
leading to possible successful retrosynthetic paths. The trained value network is used in the next iteration of the simulated
planning session alternat-ed by the retraining of the value network until it reaches the acceptable accuracy of predictions.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h2>
<p>The network architecture and training hyperparameters can be adjusted in the training configuration yaml file below.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">tree</span><span class="p">:</span>
<span class="w">  </span><span class="nt">max_iterations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">  </span><span class="nt">max_tree_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">  </span><span class="nt">max_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>
<span class="w">  </span><span class="nt">max_depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9</span>
<span class="w">  </span><span class="nt">search_strategy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">expansion_first</span>
<span class="w">  </span><span class="nt">ucb_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uct</span>
<span class="w">  </span><span class="nt">c_ucb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>
<span class="w">  </span><span class="nt">backprop_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">muzero</span>
<span class="w">  </span><span class="nt">exclude_small</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">  </span><span class="nt">min_mol_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
<span class="w">  </span><span class="nt">init_node_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">  </span><span class="nt">epsilon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">silent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="nt">node_evaluation</span><span class="p">:</span>
<span class="w">  </span><span class="nt">evaluation_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rollout</span>
<span class="w">  </span><span class="nt">evaluation_agg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max</span>
<span class="nt">node_expansion</span><span class="p">:</span>
<span class="w">  </span><span class="nt">top_rules</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">  </span><span class="nt">rule_prob_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">  </span><span class="nt">priority_rules_fraction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="nt">value_network</span><span class="p">:</span>
<span class="w">  </span><span class="nt">vector_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">  </span><span class="nt">num_conv_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">  </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0005</span>
<span class="w">  </span><span class="nt">dropout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span>
<span class="w">  </span><span class="nt">num_epoch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="nt">reinforcement</span><span class="p">:</span>
<span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">  </span><span class="nt">num_simulations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</pre></div>
</div>
<p><strong>Configuration parameters</strong>:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 42.9%" />
<col style="width: 9.5%" />
<col style="width: 47.6%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>tree:max_iterations</p></td>
<td><p>100</p></td>
<td><p>The maximum number of iterations of the tree search algorithm</p></td>
</tr>
<tr class="row-odd"><td><p>tree:max_tree_size</p></td>
<td><p>10000</p></td>
<td><p>The maximum number of nodes that can be created in the search tree</p></td>
</tr>
<tr class="row-even"><td><p>tree:max_time</p></td>
<td><p>240</p></td>
<td><p>The maximum time (in seconds) for the tree search execution</p></td>
</tr>
<tr class="row-odd"><td><p>tree:max_depth</p></td>
<td><p>9</p></td>
<td><p>The maximum depth of the tree, controlling how far the search can go from the root node</p></td>
</tr>
<tr class="row-even"><td><p>tree:ucb_type</p></td>
<td><p>uct</p></td>
<td><p>The type of Upper Confidence Bound (UCB) statistics used in the tree search. Options include “puct” (predictive UCB), “uct” (standard UCB), and “value”</p></td>
</tr>
<tr class="row-odd"><td><p>tree:backprop_type</p></td>
<td><p>muzero</p></td>
<td><p>The backpropagation method used during the tree search. Options are “muzero” (model-based approach) and “cumulative” (cumulative value approach)</p></td>
</tr>
<tr class="row-even"><td><p>tree:search_strategy</p></td>
<td><p>expansion_first</p></td>
<td><p>The strategy for navigating the tree. Options are “expansion_first” (prioritizing the expansion of new nodes) and “evaluation_first” (prioritizing the evaluation of new nodes)</p></td>
</tr>
<tr class="row-odd"><td><p>tree:exclude_small</p></td>
<td><p>True</p></td>
<td><p>If True, excludes small molecules from the tree, typically focusing on more complex molecules</p></td>
</tr>
<tr class="row-even"><td><p>tree:min_mol_size</p></td>
<td><p>6</p></td>
<td><p>The minimum size of a molecule (the number of heavy atoms) to be considered in the search. Molecules smaller than this threshold are typically considered readily available building blocks</p></td>
</tr>
<tr class="row-odd"><td><p>tree:init_node_value</p></td>
<td><p>0.5</p></td>
<td><p>The initial value for newly created nodes in the tree (for expansion_first search strategy)</p></td>
</tr>
<tr class="row-even"><td><p>tree:epsilon</p></td>
<td><p>0</p></td>
<td><p>This parameter is used in the epsilon-greedy strategy during the node selection, representing the probability of choosing a random action for exploration. A higher value leads to more exploration</p></td>
</tr>
<tr class="row-odd"><td><p>tree:silent</p></td>
<td><p>True</p></td>
<td><p>If True, suppresses the progress logging of the tree search</p></td>
</tr>
<tr class="row-even"><td><p>node_evaluation:evaluation_agg</p></td>
<td><p>max</p></td>
<td><p>The way the evaluation scores are aggregated. Options are “max” (using the maximum score of the child nodes) and “average” (using the average score of the child nodes)</p></td>
</tr>
<tr class="row-odd"><td><p>node_evaluation:evaluation_type</p></td>
<td><p>rollout</p></td>
<td><p>The method used for node evaluation. Options include “random” (random number between 0 and 1), “rollout” (using rollout simulations), and “gcn” (graph convolutional value network)</p></td>
</tr>
<tr class="row-even"><td><p>node_expansion:top_rules</p></td>
<td><p>50</p></td>
<td><p>The maximum amount of rules to be selected for node expansion from the list of predicted reaction rules</p></td>
</tr>
<tr class="row-odd"><td><p>node_expansion:rule_prob_threshold</p></td>
<td><p>0.0</p></td>
<td><p>The reaction rules with predicted probability lower than this parameter will be discarded</p></td>
</tr>
<tr class="row-even"><td><p>node_expansion:priority_rules_fraction</p></td>
<td><p>0.5</p></td>
<td><p>The fraction of priority rules in comparison to the regular rules</p></td>
</tr>
<tr class="row-odd"><td><p>value_network:vector_dim</p></td>
<td><p>512</p></td>
<td><p>The dimension of the hidden layers</p></td>
</tr>
<tr class="row-even"><td><p>value_network:num_conv_layers</p></td>
<td><p>5</p></td>
<td><p>The number of convolutional layers</p></td>
</tr>
<tr class="row-odd"><td><p>value_network:dropout</p></td>
<td><p>0.4</p></td>
<td><p>The dropout value</p></td>
</tr>
<tr class="row-even"><td><p>value_network:learning_rate</p></td>
<td><p>0.0005</p></td>
<td><p>The learning rate</p></td>
</tr>
<tr class="row-odd"><td><p>value_network:num_epoch</p></td>
<td><p>100</p></td>
<td><p>The number of training epochs</p></td>
</tr>
<tr class="row-even"><td><p>value_network:batch_size</p></td>
<td><p>1000</p></td>
<td><p>The size of the batch of input molecular graphs</p></td>
</tr>
<tr class="row-odd"><td><p>reinforcement:batch_size</p></td>
<td><p>100</p></td>
<td><p>The size of the batch of target molecules used for planning simulation and value network update</p></td>
</tr>
</tbody>
</table>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Link to this heading">¶</a></h2>
<p>Value network training can be performed with the below command.</p>
<p><strong>Important:</strong> If you use your custom building blocks, be sure to canonicalize them before planning simulations in value network tuning.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>syntool<span class="w"> </span>building_blocks_canonicalizing<span class="w"> </span>--input<span class="w"> </span>building_blocks_init.smi<span class="w"> </span>--output<span class="w"> </span>building_blocks.smi
syntool<span class="w"> </span>reinforcement_value_network_training<span class="w"> </span>--config<span class="w"> </span>reinforcement.yaml<span class="w"> </span>--targets<span class="w"> </span>targets.smi<span class="w"> </span>--reaction_rules<span class="w"> </span>reaction_rules.pickle<span class="w"> </span>--building_blocks<span class="w"> </span>building_blocks.smi<span class="w"> </span>--policy_network<span class="w"> </span>policy_network.ckpt<span class="w"> </span>--results_dir<span class="w"> </span>value_network
</pre></div>
</div>
<dl class="simple">
<dt><strong>Parameters</strong>:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">config</span></code> - the path to the configuration file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">targets</span></code> - the path to the file with target molecules for planning simulations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reaction_rules</span></code> - the path to the file with reactions rules.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">building_blocks</span></code> - the path to the file with building blocks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">policy_network</span></code> - the path to the file with trained policy network (ranking or filtering policy network).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">results_dir</span></code> - the path to the directory where the trained value network will be to be stored.</p></li>
</ul>
</dd>
</dl>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">SynTool</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_download.html">Data download</a></li>
<li class="toctree-l1"><a class="reference internal" href="reaction_standardization.html">Reaction standardization</a></li>
<li class="toctree-l1"><a class="reference internal" href="reaction_filtration.html">Reaction filtration</a></li>
<li class="toctree-l1"><a class="reference internal" href="reaction_rules_extraction.html">Reaction rules extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="policy_network.html">Policy network</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Value network</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cli">CLI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="retrosynthesis_planning.html">Retrosynthesis planning</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="policy_network.html" title="previous chapter">Policy network</a></li>
      <li>Next: <a href="retrosynthesis_planning.html" title="next chapter">Retrosynthesis planning</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, University of Strasbourg / Hokkaido University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/value_network.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>