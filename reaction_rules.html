<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Reaction rules &#8212; Syntool 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=039e1c02" />
    <script src="_static/documentation_options.js?v=f2a433a1"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Expansion function" href="expansion_function.html" />
    <link rel="prev" title="Data cleaning" href="data_cleaning.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="reaction-rules">
<h1>Reaction rules<a class="headerlink" href="#reaction-rules" title="Link to this heading">¶</a></h1>
<p>Syntool has an original protocol for reaction rule extraction</p>
<section id="reaction-mapping">
<h2>Reaction mapping<a class="headerlink" href="#reaction-mapping" title="Link to this heading">¶</a></h2>
<p>Reaction atom-to-atom (AAM) mapping in Synto is performed with GraphormerMapper, a new algorithm for AAM based on a transformer
neural network adopted for the direct processing of molecular graphs as sets of atoms and bonds, as opposed to SMILES/SELFIES
sequence-based approaches, in combination with the Bidirectional Encoder Representations from Transformers (BERT) network.
The graph transformer serves to extract molecular features that are tied to atoms and bonds. The BERT network is used for
chemical transformation learning. In a benchmarking study, it was demonstrated [<a class="reference external" href="https://doi.org/10.1021/acs.jcim.2c00344">https://doi.org/10.1021/acs.jcim.2c00344</a>]
that GraphormerMapper is superior to the state-of-the-art IBM RxnMapper algorithm in the “Golden” benchmarking data set
(total correctly mapped reactions 89.5% vs. 84.5%).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">chython</span> <span class="kn">import</span> <span class="n">smiles</span>

<span class="n">chython_reaction</span> <span class="o">=</span> <span class="n">smiles</span><span class="p">(</span><span class="s1">&#39;C(O)CBr.O=S(=O)(CC)Cl&gt;C(C)OCC&gt;O=S(=O)(CC)OCCBr&#39;</span><span class="p">)</span>
<span class="n">chython_reaction</span><span class="o">.</span><span class="n">reset_mapping</span><span class="p">()</span>
<span class="n">mapped_smiles</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">chython_reaction</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mapped_smiles</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="p">[</span><span class="n">CH2</span><span class="p">:</span><span class="mi">1</span><span class="p">]([</span><span class="n">CH2</span><span class="p">:</span><span class="mi">3</span><span class="p">][</span><span class="n">Br</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="n">OH</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">O</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">6</span><span class="p">](</span><span class="o">=</span><span class="p">[</span><span class="n">O</span><span class="p">:</span><span class="mi">7</span><span class="p">])([</span><span class="n">CH2</span><span class="p">:</span><span class="mi">8</span><span class="p">][</span><span class="n">CH3</span><span class="p">:</span><span class="mi">9</span><span class="p">])[</span><span class="n">Cl</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">&gt;</span><span class="p">[</span><span class="n">CH3</span><span class="p">:</span><span class="mi">21</span><span class="p">][</span><span class="n">CH2</span><span class="p">:</span><span class="mi">20</span><span class="p">][</span><span class="n">O</span><span class="p">:</span><span class="mi">22</span><span class="p">][</span><span class="n">CH2</span><span class="p">:</span><span class="mi">23</span><span class="p">][</span><span class="n">CH3</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span><span class="o">&gt;</span><span class="p">[</span><span class="n">O</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">6</span><span class="p">](</span><span class="o">=</span><span class="p">[</span><span class="n">O</span><span class="p">:</span><span class="mi">7</span><span class="p">])([</span><span class="n">CH2</span><span class="p">:</span><span class="mi">8</span><span class="p">][</span><span class="n">CH3</span><span class="p">:</span><span class="mi">9</span><span class="p">])[</span><span class="n">O</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="n">CH2</span><span class="p">:</span><span class="mi">1</span><span class="p">][</span><span class="n">CH2</span><span class="p">:</span><span class="mi">3</span><span class="p">][</span><span class="n">Br</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="reaction-filtration">
<h2>Reaction filtration<a class="headerlink" href="#reaction-filtration" title="Link to this heading">¶</a></h2>
<p>In Syntool, reaction data filtration is a crucial step to ensure the quality and accuracy of the data used for retrosynthesis analysis.
The USPTO dataset, a standardized but unfiltered collection of reaction records, serves as the primary data source.
However, this dataset may contain records with no reaction center or atom-to-atom mapping errors. To address this, we apply
several filters:</p>
<blockquote>
<div><ul class="simple">
<li><p>No Reaction Filter: Removes reactions with identical reactants and products.</p></li>
<li><p>Small Molecules Filter: Excludes reactions where all reactants and products have ≤ specified number of heavy atoms.</p></li>
<li><p>Reaction Distance Filter: Discards reactions with more than specified changed bonds.</p></li>
<li><p>Multi-Center Reaction Filter: Eliminates records with multiple reaction centers.</p></li>
<li><p>Csp3-C Breaking Filter: Removes reactions where a bond between two sp3 carbons is broken, indicating potential mapping errors.</p></li>
<li><p>C-C Ring Breaking Filter: Filters out reactions breaking a bond between two carbons in the same ring (sizes 5, 6, or 7), identified using the SSSR algorithm.</p></li>
<li><p>C-H Breaking Filter: Removes reactions breaking a C-H bond to form a C-C bond, with exceptions for condensation reactions or those involving carbenes.</p></li>
</ul>
</div></blockquote>
</section>
<section id="reaction-rule-extraction">
<h2>Reaction rule extraction<a class="headerlink" href="#reaction-rule-extraction" title="Link to this heading">¶</a></h2>
<p>After filtering the reaction data, the next crucial step in Synto is the extraction of reaction rules. This process is vital
for retrosynthetic analysis, as it defines the patterns and transformations that can be applied to synthesize target molecules.
The protocol for extracting retro-rules from reactions in Synto utilizes the CGRtools Python library. This procedure involves the
following steps:</p>
<blockquote>
<div><ul class="simple">
<li><p>Substructure Extraction: For each reactant and product in a given reaction, substructures containing the atoms of the reaction center and their immediate environment are extracted.</p></li>
<li><p>Substructure Exchange: The reactant and product substructures are then exchanged.</p></li>
<li><p>Reagents Handling: If the reaction includes reagents, they are not incorporated into the retro-rule.</p></li>
<li><p>Label Preservation: All labels related to the atoms of the reaction center, such as hybridization, the number of neighbors, and the ring sizes in which the atoms participate, are preserved. For atoms in the first environment, only the sizes of rings are preserved.</p></li>
</ul>
</div></blockquote>
<p>A retrosynthetic transformation formed by this protocol is applied to the product of the original reaction. If it successfully
generates the reactants of the reaction, the rule is considered valid.</p>
<p>The ExtractRuleConfig class in Synto allows for the fine-tuning of how reaction rules are extracted. Key parameters of this class include:</p>
<ul class="simple">
<li><p>multicenter_rules: Determines whether a single rule is extracted for all centers in multicenter reactions (True) or if separate rules are generated for each center (False). The default is True.</p></li>
<li><p>as_query_container: When set to True, the extracted rules are formatted as QueryContainer objects, similar to SMARTS for chemical pattern matching. The default is True.</p></li>
<li><p>reverse_rule: If True, the direction of the reaction is reversed during rule extraction, which is useful for retrosynthesis. The default is True.</p></li>
<li><p>reactor_validation: Activates the validation of each generated rule in a chemical reactor to confirm the accurate generation of products from reactants when set to True. The default is True.</p></li>
<li><p>include_func_groups: If True, specific functional groups are included in the reaction rule in addition to the reaction center and its environment. The default is False.</p></li>
<li><p>func_groups_list: Specifies a list of functional groups to be included when include_func_groups is True.</p></li>
<li><p>include_rings: Includes ring structures in the reaction rules connected to the reaction center atoms if set to True. The default is False.</p></li>
<li><p>keep_leaving_groups: Keeps the leaving groups in the extracted reaction rule when set to True. The default is False.</p></li>
<li><p>keep_incoming_groups: Retains incoming groups in the extracted reaction rule if set to True. The default is False.</p></li>
<li><p>keep_reagents: Includes reagents in the extracted reaction rule when True. The default is False.</p></li>
<li><p>environment_atom_count: Sets the number of layers of atoms around the reaction center to be included in the rule. A value of 0 includes only the reaction center, 1 includes the first surrounding layer, and so on. The default is 1.</p></li>
<li><p>min_popularity: Establishes the minimum number of times a rule must be applied to be included in further analysis. The default is 3.</p></li>
<li><p>keep_metadata: Preserves associated metadata with the reaction in the extracted rule when set to True. The default is False.</p></li>
<li><p>single_reactant_only: Limits the extracted rules to those with only a single reactant molecule if True. The default is True.</p></li>
<li><p>atom_info_retention: Dictates the level of detail retained about atoms in the reaction center and their environment. Default settings retain information about neighbors, hybridization, implicit hydrogens, and ring sizes for both the reaction center and its environment.</p></li>
</ul>
<p>After configuring the rule extraction settings in Synto, the next step is to apply these configurations to extract reaction rules from our dataset:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">CGRtools</span> <span class="kn">import</span> <span class="n">smiles</span>
<span class="kn">from</span> <span class="nn">Synto.chem.reaction_rules.extraction</span> <span class="kn">import</span> <span class="n">ExtractRuleConfig</span>
<span class="kn">from</span> <span class="nn">Synto.chem.reaction_rules.extraction</span> <span class="kn">import</span> <span class="n">create_rule</span>

<span class="c1"># read config</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">ExtractRuleConfig</span><span class="p">()</span>

<span class="c1"># extract reaction rule</span>
<span class="n">mapped_reaction</span> <span class="o">=</span> <span class="n">smiles</span><span class="p">(</span><span class="n">mapped_smiles</span><span class="p">)</span>
<span class="n">extracted_rule</span> <span class="o">=</span> <span class="n">create_rule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">mapped_reaction</span><span class="p">)</span>

<span class="c1"># result</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reaction: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">mapped_reaction</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="n">Reaction</span><span class="p">:</span> <span class="n">C</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="n">CBr</span><span class="o">.</span><span class="n">O</span><span class="o">=</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="n">CC</span><span class="p">)</span><span class="n">Cl</span><span class="o">&gt;</span><span class="n">C</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="n">OCC</span><span class="o">&gt;</span><span class="n">O</span><span class="o">=</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="n">CC</span><span class="p">)</span><span class="n">OCCBr</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reaction rule: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">extracted_rule</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="n">Reaction</span> <span class="n">rule</span><span class="p">:</span> <span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">S</span><span class="p">](</span><span class="o">=</span><span class="p">[</span><span class="n">O</span><span class="p">])(</span><span class="o">-</span><span class="p">[</span><span class="n">C</span><span class="p">])</span><span class="o">-</span><span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">-</span><span class="p">[</span><span class="n">C</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">[</span><span class="n">C</span><span class="p">]</span><span class="o">-</span><span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">S</span><span class="p">](</span><span class="o">=</span><span class="p">[</span><span class="n">O</span><span class="p">])(</span><span class="o">-</span><span class="p">[</span><span class="n">Cl</span><span class="p">])</span><span class="o">-</span><span class="p">[</span><span class="n">C</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="reaction-rule-application">
<h2>Reaction rule application<a class="headerlink" href="#reaction-rule-application" title="Link to this heading">¶</a></h2>
<p>The extracted reaction rule can be applied then:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">CGRtools</span> <span class="kn">import</span> <span class="n">CGRReactor</span>
<span class="kn">from</span> <span class="nn">CGRtools.containers</span> <span class="kn">import</span> <span class="n">MoleculeContainer</span>

<span class="c1"># create reactor</span>
<span class="n">retro_reactor</span> <span class="o">=</span> <span class="n">CGRReactor</span><span class="p">(</span><span class="n">extracted_rule</span><span class="p">)</span>

<span class="c1"># apply extracted reaction rule</span>
<span class="n">product</span> <span class="o">=</span> <span class="n">example_reaction</span><span class="o">.</span><span class="n">products</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">generated_reactant_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">retro_reactor</span><span class="p">(</span><span class="n">product</span><span class="p">))</span>
<span class="n">generated_reactants</span> <span class="o">=</span> <span class="n">generated_reactant_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">generated_reactants</span><span class="p">:</span>
    <span class="n">i</span><span class="o">.</span><span class="n">clean2d</span><span class="p">()</span>
<span class="n">generated_reactants</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">generated_reactants</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reaction rule: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">extracted_rule</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="n">Reaction</span> <span class="n">rule</span><span class="p">:</span> <span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">S</span><span class="p">](</span><span class="o">=</span><span class="p">[</span><span class="n">O</span><span class="p">])(</span><span class="o">-</span><span class="p">[</span><span class="n">C</span><span class="p">])</span><span class="o">-</span><span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">-</span><span class="p">[</span><span class="n">C</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">[</span><span class="n">C</span><span class="p">]</span><span class="o">-</span><span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">O</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">S</span><span class="p">](</span><span class="o">=</span><span class="p">[</span><span class="n">O</span><span class="p">])(</span><span class="o">-</span><span class="p">[</span><span class="n">Cl</span><span class="p">])</span><span class="o">-</span><span class="p">[</span><span class="n">C</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Product: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="n">Product</span><span class="p">:</span> <span class="n">O</span><span class="o">=</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="n">C</span><span class="p">)</span><span class="n">OCCCBr</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reactants: </span><span class="si">{</span><span class="n">generated_reactants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">generated_reactants</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="n">Reactants</span><span class="p">:</span> <span class="n">O</span><span class="o">=</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="n">Cl</span><span class="p">)</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="p">(</span><span class="n">CCBr</span><span class="p">)</span><span class="n">O</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Syntool</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfaces.html">Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_cleaning.html">Data cleaning</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Reaction rules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#reaction-mapping">Reaction mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reaction-filtration">Reaction filtration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reaction-rule-extraction">Reaction rule extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reaction-rule-application">Reaction rule application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="expansion_function.html">Expansion function</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation_function.html">Evaluation function</a></li>
<li class="toctree-l1"><a class="reference internal" href="tree_search.html">Tree search</a></li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="planning.html">Planning</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="data_cleaning.html" title="previous chapter">Data cleaning</a></li>
      <li>Next: <a href="expansion_function.html" title="next chapter">Expansion function</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, University of Strasbourg.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/reaction_rules.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>